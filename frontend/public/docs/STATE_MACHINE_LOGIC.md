# 加密市场状态机 - 计算逻辑详解

本文档详细说明加密市场状态机的所有计算逻辑和判断规则。

---

## 一、核心架构

状态机通过**两个输入维度**确定四象限状态，并通过**两个校验层**评估风险与加速度：

```
输入维度（确定象限）
├── 趋势结构 (Trend Structure)
└── 资金姿态 (Funding Posture)

校验层（评估风险）
├── 风险温度计 (Risk Thermometer)
└── ETF 加速器 (ETF Accelerator)
```

---

## 二、输入维度 1：趋势结构 (Trend Structure)

### 2.1 数据来源

- **MA50（中期节奏线）**：50日移动平均线
- **MA200（长期生命线）**：200日移动平均线
- **BTC 当前价格**：实时 BTC/USDT 价格

**数据提供方**：Binance API（公开免费）

### 2.2 判断规则

#### 多头骨架（趋势多）

满足以下**所有条件**：

1. **价格位置**：`BTC价格 > MA200`
2. **斜率条件**：`MA200斜率 >= 0`（走平或向上）

#### 空头骨架（趋势空）

满足以下**所有条件**：

1. **价格位置**：`BTC价格 < MA200`
2. **斜率条件**：`MA200斜率 < 0`（趋势向下）

#### 降级规则

- 价格在 MA200 上方但 MA200 斜率 < 0：趋势多（弱）
- 价格在 MA200 下方但 MA200 斜率 >= 0：趋势空（弱）

### 2.3 斜率计算方法

斜率通过计算移动平均线的变化率得出：

```
MA斜率：对最近N天MA取对数后做线性回归
斜率百分比 = (exp(slope_log) - 1) × 100%
```

其中 N 通常取 7-14 天，用于评估短期趋势方向。

### 2.4 趋势质量判定

- **MA50 在 MA200 上方**：说明中期趋势跟得上，市场有推动力
- **MA50 在 MA200 下方**：   说明中期趋势垮了，反弹像喘口气
- **价格 < MA50 < MA200**：典型的空头排列。中期节奏都不能修复。此时的反弹仅视为压力位修复，而非反转。
- **价格 > MA50 > MA200**：   多头排列
---

## 三、输入维度 2：资金姿态 (Funding Posture)

### 3.1 数据来源

- **稳定币市值 (Stablecoin Market Cap)**：USDT、USDC、DAI 等主要稳定币的总市值
- **加密总市值 (Total Market Cap)**：所有加密货币的总市值
- **稳定币占比**：`稳定币市值 / 加密总市值 × 100%`

**数据提供方**：CoinGecko API（公开免费）

### 3.2 判断规则

#### 资金进攻

满足以下**任一条件**：

1. **增量进场**：`稳定币占比下降`（资金从稳定币流入风险资产）
2. **存量换筹**：`稳定币占比 < 阈值` 且 `稳定币占比变化 < 0`（最强进攻信号）

**阈值**：通常为 8-10%，可根据市场环境调整

#### 资金防守

满足以下**任一条件**：

1. **资金避险**：`稳定币占比上升`（资金从风险资产流入稳定币，典型去风险）
2. **资金离场**：`稳定币占比 > 阈值` 且 `稳定币占比变化 > 0`（资金彻底离场，深熊压力）

### 3.3 稳定币占比变化计算

```
稳定币占比变化 = 当前稳定币占比 - N天前的稳定币占比
```

其中 N 通常取 7-30 天，用于评估资金流向趋势。

---

## 四、四象限状态映射

根据趋势结构和资金姿态的组合，映射到四个市场状态：

| 状态 | 趋势结构 | 资金姿态 | 风险等级 | 逻辑直觉 |
|------|---------|---------|---------|---------|
| **牛市进攻** | 趋势多 | 资金进攻 | HIGH | 增量资金推动创新高 |
| **牛市修复** | 趋势多 | 资金防守 | MEDIUM | 大趋势在，但资金开始避险 |
| **熊市反弹** | 趋势空 | 资金进攻 | MEDIUM | 存量博弈下的技术性抽风 |
| **熊市消化** | 趋势空 | 资金防守 | LOW | 最折磨人的去风险/阴跌期 |

---

## 五、校验层 1：风险温度计 (Risk Thermometer)

### 5.1 数据来源

- **ATH（历史最高价）**：从历史价格数据中提取的最高价格
- **BTC 当前价格**：实时 BTC/USDT 价格

### 5.2 计算公式

```
ATH回撤率 = (ATH - 当前价格) / ATH × 100%
```

**注意**：回撤率为**正数**，表示从 ATH 回撤了多少百分比。

### 5.3 风险等级判定

| 回撤率范围 | 风险等级 | 状态描述 |
|-----------|---------|---------|
| `< 20%` | 正常体温 | 健康，可大胆进攻 |
| `20% ~ 35%` | 低/中烧 | 市场难受，需要修复 |
| `35% ~ 60%` | 高烧 | 熊市主导概率大增 |
| `≥ 60%` | 生命垂危 | 深出清阶段 |

### 5.4 特殊情况处理

- 如果当前价格 ≥ ATH（创新高），回撤率为 0，判定为"正常体温"
- 如果无法获取历史数据，使用当前价格作为 ATH（回撤率为 0）

---

## 六、校验层 2：ETF 加速器 (ETF Accelerator)

### 6.1 数据来源

- **ETF 净流入/流出 (ETF Net Flow)**：现货 ETF 的净资金流入（正数）或流出（负数）
- **ETF 管理规模 (ETF AUM)**：ETF 的总资产管理规模

**数据提供方**：Farside Investors（净流入）+ yfinance（AUM）

### 6.2 判断规则

#### 顺风（加速）

- **条件**：`ETF净流入 > 0` 且持续流入
- **含义**：持续流入，加速上涨趋势

#### 逆风（抑制）

- **条件**：`ETF净流入 < 0` 且持续流出
- **含义**：持续流出，放大下跌压力

#### 钝化

- **条件**：流出速度减缓或接近平衡
- **含义**：流出速度减缓，通常意味着卖压衰竭，可能转入震荡消化

### 6.2.1 补充说明（实现口径）

- **持续 2-4 周**：至少 14 天历史，且同方向天数占比 >= 70%。
- **AUM 回升**：若无历史 AUM，使用近 14 天净流入累计为正作为近似。
- **历史不足**：保留单日净流入作为启发式判断。

### 6.3 状态判定逻辑

```
if ETF净流入持续 > 0 (2-4周):
    返回 "顺风"
elif ETF净流入持续 < 0 (2-4周):
    返回 "逆风"
elif 流出速度减缓:
    返回 "钝化"
else:
    返回 "未知"
```

---

## 七、核心切换逻辑（何时转牛？）

**实现口径（可计算化）：**
- **收复均线**：`BTC > MA50` 且 `BTC > MA200` 连续 N 天（建议 N=3~7）。
- **止跌确认**：`BTC > MA50` 连续 N 天，或 `MA50 斜率 >= 0` 连续 N 天。
- **资金回流**：稳定币市值斜率 <= 0 或 稳定币占比变化 <= 0，连续 N 天。
- **ETF 转正**：净流入持续 ≥14 天且同方向占比 ≥70%，AUM 回升（无 AUM 历史时用近 14 天净流入累计为正近似）。


从"熊市消化"转为"牛市"需要至少看到以下信号中的 **3 个同时出现**：

### 7.1 收复均线

比特币依次收复 `MA50` 和 `MA200` 并站稳：
- `BTC价格 > MA50` 且 `BTC价格 > MA200`
- `MA50斜率 > 0` 且 `MA200斜率 > 0`
- 持续站稳 N 天（通常 3-7 天）

### 7.2 资金回流

稳定币市值停止上升，开始平稳或下降：
- `稳定币占比变化 < 0`（资金愿意承担风险）
- 持续 N 天（通常 7-14 天）

### 7.3 ETF 转正

ETF 从持续流出转为持续流入：
- `ETF净流入 > 0`
- 持续超过 **2-4 周**

### 7.4 规模回升

ETF 总资产（AUM）显著回升：
- `ETF AUM` 较最低点回升超过阈值（通常 20-30%）

---

## 八、状态机执行流程

```
1. 数据获取
   ├── 获取 BTC 价格
   ├── 获取 MA50、MA200 及其历史数据
   ├── 获取稳定币市值和总市值
   ├── 获取历史价格数据（用于计算 ATH）
   └── 获取 ETF 数据（如果可用）

2. 计算趋势结构
   ├── 计算 MA50 斜率
   ├── 计算 MA200 斜率
   └── 判断：趋势多 / 趋势空

3. 计算资金姿态
   ├── 计算稳定币占比
   ├── 计算稳定币占比变化
   └── 判断：资金进攻 / 资金防守

4. 映射到四象限状态
   └── 根据趋势 × 资金姿态 → 确定市场状态

5. 计算校验层
   ├── 计算 ATH 回撤率 → 风险温度计
   └── 计算 ETF 状态 → ETF 加速器

6. 计算置信度
   └── 基于趋势清晰度和资金信号强度

7. 返回结果
   └── 包含状态、校验层、置信度、元数据
```

---

## 九、数据缓存策略

为了减少 API 调用和提高响应速度：

- **缓存时间**：5 分钟
- **缓存键**：基于数据类型和时间窗口
- **缓存失效**：数据过期后自动重新获取

---

## 十、注意事项

### 10.1 数据延迟

- API 数据可能存在延迟（通常 1-5 分钟）
- 历史数据可能需要时间聚合

### 10.2 边界情况

- 当数据不足时，系统会使用合理的默认值或占位符
- 当多个条件同时满足时，优先使用更严格的判定条件

### 10.3 参数调整

以下参数可根据市场环境调整：

- **稳定币占比阈值**：默认 8-10%
- **斜率计算周期**：默认 7-14 天
- **稳定币占比变化周期**：默认 7-30 天
- **均线站稳天数**：默认 3-7 天

---

## 十一、公式总结

### 11.1 趋势结构

```
趋势多 = (BTC价格 > MA200) AND (MA200斜率 >= 0)
趋势空 = (BTC价格 < MA200) AND (MA200斜率 < 0)
```
降级规则：价格在 MA200 上方但 MA200 斜率 < 0 仍判为趋势多（弱）；价格在 MA200 下方但 MA200 斜率 >= 0 仍判为趋势空（弱）。


### 11.2 资金姿态

```
资金进攻 = (稳定币占比变化 < 0) OR (稳定币占比 < 阈值 AND 稳定币占比变化 < 0)
资金防守 = (稳定币占比变化 > 0) OR (稳定币占比 > 阈值 AND 稳定币占比变化 > 0)
```

### 11.3 风险温度计

```
ATH回撤率 = (ATH - 当前价格) / ATH × 100%
```

### 11.4 斜率计算

```
MA斜率：对最近N天MA取对数后做线性回归
斜率百分比 = (exp(slope_log) - 1) × 100%
```

### 11.5 稳定币占比

```
稳定币占比 = 稳定币市值 / 加密总市值 × 100%
稳定币占比变化 = (当前占比 - N天前的占比) × 100%
```

---

## 十二、参考资料

- 视频：《牛市还是熊市？10秒判断牛熊》https://www.youtube.com/watch?v=mVURehbJ_LA   
- 项目文档：[状态模型设计](STATE_MODEL.md)
- 数据来源：[数据来源说明](DATA_SOURCES.md)

---

**最后更新**：2025年

**版本**：1.0

